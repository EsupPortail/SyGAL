<?php

/**
 * @var Application\Entity\Db\These $these
 * @var Application\Entity\Db\Validation $validationBDD
 * @var Soutenance\Entity\Proposition $proposition
 * @var \Application\Entity\Db\Validation $validationPDC
 *
 * @see Soutenance\Controller\Presoutenance\PresoutenanceController::presoutenanceAction()
 */

use Application\Constants;

$tousLesAvis = count($rapporteurs) === count($avis) ;

$this->headTitle('Préparation de la soutenance de '.$these->getDoctorant()->getIndividu());
?>

<h1 class="page-header">
    Préparation de la soutenance
    <small><?php echo $this->partial('application/these/partial/titre') ?></small>
</h1>

<?php
    $messenger = $this->messenger();
    echo $this->messenger()->addMessagesFromFlashMessenger();
?>

<?php if ($validationBDD) : ?>
    <?php if ($proposition->getNouveauTitre() !== null) : ?>
    <div class="box panel panel-warning">
        <div class="panel-heading">
            <h2>Changement de titre</h2>
        </div>
        <div class="panel-body">
            <?php echo $proposition->getNouveauTitre(); ?>
        </div>
    </div>
    <?php endif; ?>

    <!-- DATE DE RENDU DE RAPPORT ----------------------------------------------------------------------------------------->
    <?php echo $this->partial('soutenance/presoutenance/partial/date-de-retour'); ?>

    <!-- MEMBRES DU JURY ET PERSOPASS ------------------------------------------------------------------------------------->
    <?php echo $this->partial('soutenance/presoutenance/partial/association-jury'); ?>

    <!-- ENGAGEMENT IMPARTIALITE------------------------------------------------------------------------------------------->
    <?php echo $this->partial('soutenance/presoutenance/partial/engagement-impartialite'); ?>

    <div class="box panel panel-info">
        <div class="panel-heading">
            <h2>Validation de la page de couverture</h2>
        </div>
        <div class="panel-body">
            <?php
                $ok_rapporteurs = false;
                $tousLesRapporteurs = true;
                foreach ($rapporteurs as $rapporteur) {
                    if ($rapporteur->getActeur() === null) {
                        $tousLesRapporteurs = false;
                        break;
                    }
            }
            $tousLesEngagements = count($rapporteurs) === count($engagements) ;
            ?>
            <?php if ($tousLesEngagements) : ?>
                <?php if ($validationPDC !== null) : ?>
                    La page de couverture a été validée le
                    <?php echo current($validationPDC)->getHistoModification()->format(Constants::DATETIME_FORMAT); ?>
                    par
                    <?php echo current($validationPDC)->getHistoModificateur()->getDisplayName(); ?>.
                <?php else : ?>
                    <div class="row">
                        <div class="col-md-8">
                            Vous pouvez maintenant valider la page de couverture.
                        </div>
                        <div class="pull-right" style="margin-right: 2rem;">
                            <a href="<?php echo $this->url('these/validation-page-de-couverture', ['these' => $these->getId()], [], true); ?>" class="btn btn-primary">
                                Accéder à la validation de la PDC
                            </a>
                        </div>
                    </div>
                <?php endif; ?>
            <?php else : ?>
                    Tous les engagments d'impartialité n'ont pas encore été signés.
            <?php endif; ?>
        </div>
    </div>
    <!-- AVIS SOUTENANCE -------------------------------------------------------------------------------------------------->
    <?php echo $this->partial('soutenance/presoutenance/partial/avis-soutenance'); ?>

    <!-- FEU VERT --------------------------------------------------------------------------------------------------------->
    <?php if ($tousLesAvis) : ?>
        <a href="<?php echo $this->url('soutenance/presoutenance/feu-vert', ['these' => $these->getId()], [], true); ?>"
            class="btn btn-primary pull-right"
        >
            <span class="glyphicon glyphicon-thumbs-up"></span>
            Donner le feu vert pour la soutenance
        </a>
    <?php endif; ?>
<?php else : ?>
    <p class="lead">
        Vous ne pouvez commencer les démarches de présouteances qu'une fois toutes les validations obtenues.
    </p>
<?php endif; ?>

<script>
    $(function() {
        $("body").on("modification-date-rendu-rapport", function (event) {
            event.div.modal('hide');
            window.location.reload();
        });
    });
</script>