<?php

/**
 * @var These $these
 * @var Proposition $proposition
 * @var Membre[] $rapporteurs
 * @var array $engagements
 */

use Application\Entity\Db\These;
use Application\Entity\Db\Validation;
use Soutenance\Provider\Privilege\SoutenancePrivileges;
use Soutenance\Entity\Membre;
use Soutenance\Entity\Proposition;

$canEditDateRenduRapport        = $this->isAllowed(SoutenancePrivileges::getResourceId(SoutenancePrivileges::SOUTENANCE_MODIFICATION_DATE_RENDU_RAPPORT));
$canEditPersopass               = $this->isAllowed(SoutenancePrivileges::getResourceId(SoutenancePrivileges::SOUTENANCE_MODIFICATION_PERSOPASS));

$canVisualiserEngagementImpartialite = $this->isAllowed($these, SoutenancePrivileges::SOUTENANCE_ENGAGEMENT_IMPARTIALITE_VISUALISER);
$canNotifierEngagementImpartialite = $this->isAllowed($these, SoutenancePrivileges::SOUTENANCE_ENGAGEMENT_IMPARTIALITE_NOTIFIER);
?>

<!-- TITRE ET NOTE ---------------------------------------------------------------------------------------------------->

<div class="row">
    <div class="pull-right panel panel-warning" role="alert">
        <div class="panel-heading">
            <div class="panel panel-success" role="alert">
                <div class="panel-heading">
                    Accessible par le BDD et les admins.
                </div>
            </div>

            <strong>Note:</strong> Accessible après que toutes les validations ont été effectuées :
            <ol>
                <li> Doctorant,</li>
                <li> Directeurs et Co-directeurs, </li>
                <li> Unité de recherche, </li>
                <li> École doctorale,</li>
                <li> Maison des doctorats.</li>
            </ol>
        </div>
    </div>

    <h1 class="page-header"> Préparation de la soutenance </h1>
</div>

<!-- DATE DE RENDU DE RAPPORT ----------------------------------------------------------------------------------------->

<div class=" panel panel-info">

    <div class="panel-heading">
        <h2> Date de retour des rapports </h2>
    </div>

    <div class="panel-body">

        <p class="lead">
            Les rapports doivent être reçu un mois avant la date de soutenance.
        </p>

        <div class="pull-left">
            Date de retour :
            <strong><?php echo $proposition->getRenduRapport()->format('d/m/Y'); ?> </strong>
        </div>

        <?php if($canEditDateRenduRapport): ?>
        <div class="pull-right">
            <a
                href="<?php echo $this->url('soutenance/presoutenance/date-rendu-rapport', ['these' => $these->getId()], [] , true); ?>"
                class="btn btn-primary action ajax-modal"
                data-event="modification-date-rendu-rapport"
            >
                <span class="glyphicon glyphicon-pencil"></span> Modifier
            </a>
        </div>
        <?php endif; ?>

    </div>

</div>

<!-- MEMBRES DU JURY ET PERSOPASS ------------------------------------------------------------------------------------->

<div class=" panel panel-info">

    <div class="panel-heading">
        <h2> PersoP@ss </h2>
    </div>

    <div class="panel-body">

        <p class="lead">
            Tous les membres du jury doivent possèder un PersoP@ss afin de pouvoir se connecter à l'application.
        </p>

        <table class="table table-extra-condensed">
            <thead>
            <tr>
                <th> Dénomination </th>
                <th> Qualité </th>
                <th> PersoP@ss </th>
                <th> Création </th>
                <th> Action </th>
            </tr>
            </thead>
            <tbody>
            <?php foreach ($proposition->getMembres() as $membre): ?>
                <tr>
                    <td>    <?php echo $membre->getDenomination(); ?>                                                   </td>
                    <td>    <?php echo $membre->getQualite()->getLibelle(); ?>                                          </td>
                    <td>    <?php echo $membre->getPersopass(); ?>                                                      </td>
                    <td>    <?php echo ($membre->isNouveau())?'<span class="glyphicon glyphicon-ok"></span>':''; ?>     </td>
                    <td>
                        <?php if($canEditPersopass): ?>
                        <a
                            href="<?php echo $this->url('soutenance/persopass/modifier', ['these' => $these->getId(), 'membre' => $membre->getId()], [], true); ?>"
                            class="ajax-modal"
                            data-event="modifier-persopass">
                            <span class="glyphicon glyphicon-pencil"></span>
                        </a>
                        <?php endif; ?>
                    </td>
                </tr>
            <?php endforeach; ?>
            </tbody>
        </table>

    </div>

</div>

<!-- DEMANDE D'EXPERTISE ---------------------------------------------------------------------------------------------->

<div class=" panel panel-info">
    <div class="panel-heading">
        <h2> Engagements d'impartialité</h2>
    </div>
    <div class="panel-body">
        <p class="lead">
            Afin de devenir officiellement rapporteur de cette thèse les futurs rapporteurs doivent signer un engagement
            d'impartialité.
        </p>

        <table class="table table-extra-condensed">
            <thead>
            <tr>
                <th> Rapporteur </th>
                <th> Signé </th>
                <th> Actions </th>
            </tr>
            </thead>
            <tbody>
                <?php
                    /** @var Membre $rapporteur */
                foreach ($rapporteurs as $rapporteur) : ?>
                <tr>
                    <td> <?php echo $rapporteur->getDenomination(); ?> </td>
                    <td>
                        <?php if ($rapporteur->getIndividu()) : ?>
                            <?php if (isset($engagements[$rapporteur->getIndividu()->getId()])): ?>
                                <?php
                                    /** @var Validation $validation */
                                    $validation = $engagements[$rapporteur->getIndividu()->getId()];
                                    echo $validation->getHistoCreation()->format("d/m/Y à H:i");
                                ?>
                            <?php else: ?>
                                <i> Non signé </i>
                            <?php endif; ?>
                        <?php else: ?>
                            <i> N'est pas un individu SyGAL</i>
                        <?php endif; ?>
                    </td>
                    <td>
                        <?php if($canVisualiserEngagementImpartialite): ?>
                            <a href="<?php echo $this->url('soutenance/presoutenance/engagement-impartialite', ['these' => $these->getId(), 'proposition' => $proposition->getId(), 'membre' => $rapporteur->getId()], [], true);?>">
                                <span class="glyphicon glyphicon-eye-open" title="Visualiser l'engagement d'impartialité"></span>
                            </a>
                        <?php endif; ?>
                        <?php if($canNotifierEngagementImpartialite): ?>
                        <a href="<?php echo $this->url('soutenance/presoutenance/engagement-impartialite/notifier', ['these' => $these->getId(), 'proposition' => $proposition->getId(), 'membre' => $rapporteur->getId()], [], true);?>">
                            <span class="glyphicon glyphicon-send" title="Notifier le rapporteur"></span>
                        </a>
                        <?php endif; ?>
                    </td>
                </tr>
                <?php endforeach; ?>
            </tbody>
        </table>

        <?php if($canNotifierEngagementImpartialite): ?>
            <a href="<?php echo $this->url('soutenance/presoutenance/notifier-engagement-impartialite', ['these' => $these->getId(), 'proposition' => $proposition->getId()], [], true);?>"
               class="btn btn-info">
                <span class="glyphicon glyphicon-send"></span> Envoyer les notifications aux rapporteurs
            </a>
        <?php endif; ?>
    </div>
</div>



<script>
    $(function() {
        $("body").on("modifier-persopass", function (event) {
            event.div.modal('hide');
            window.location.reload();
        });
    });
    $(function() {
        $("body").on("modification-date-rendu-rapport", function (event) {
            event.div.modal('hide');
            window.location.reload();
        });
    });
</script>