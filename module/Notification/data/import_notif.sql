/*
drop table IMPORT_OBS_NOTIF;
drop table IMPORT_OBS_RESULT_NOTIF;
drop table NOTIF_RESULT;
drop table NOTIF_DEST;
drop table NOTIF;

DROP sequence IMPORT_OBS_NOTIF_ID_SEQ;
DROP sequence IMPORT_OBS_RESULT_NOTIF_ID_SEQ;
DROP sequence NOTIF_ID_SEQ;
DROP sequence NOTIF_DEST_ID_SEQ;
DROP sequence NOTIF_RESULT_ID_SEQ;
*/

-- notification
CREATE TABLE NOTIF (
  ID            NUMBER                  NOT NULL CONSTRAINT NOTIF_PK PRIMARY KEY,
  CODE          VARCHAR(100)            NOT NULL,
  DESCRIPTION   VARCHAR(255)            NOT NULL,
  DESTINATAIRES VARCHAR(500)            NOT NULL,
  TEMPLATE      CLOB                    NOT NULL, -- template du message
  ENABLED       SMALLINT     DEFAULT 1  NOT NULL
);

/*
-- destinataires d'une notification
CREATE TABLE NOTIF_DEST (
  ID          NUMBER       NOT NULL CONSTRAINT NOTIF_DEST_PK PRIMARY KEY,
  NOTIF_ID    NUMBER       NOT NULL CONSTRAINT NOTIF_DEST__NOTIF_FK REFERENCES NOTIF(ID) ON DELETE CASCADE,
  --DESCRIPTION VARCHAR(255) NOT NULL,
  EMAIL       VARCHAR(500) NOT NULL,
  TEMPLATE    CLOB         -- template du message
);

create sequence NOTIF_DEST_ID_SEQ;

INSERT INTO NOTIF_DEST (ID, NOTIF_ID, EMAIL)
  WITH D(CODE_NOTIF, EMAIL) AS (
    SELECT 'NOTIF_RESULTAT_PASSE_A_ADMIS__POUR_DOCTORANT',  '{doctorant}'  FROM DUAL UNION
    SELECT 'NOTIF_RESULTAT_PASSE_A_ADMIS__POUR_BDD'      ,  'recherche.doctorat@unicaen.fr' FROM DUAL UNION
    SELECT 'NOTIF_RESULTAT_PASSE_A_ADMIS__POUR_BDD'      ,  'bertrand.gauthier@unicaen.fr, bruno.bernard@unicaen.fr' FROM DUAL
  )
  SELECT NOTIF_DEST_ID_SEQ.nextval, N.ID, D.EMAIL
  FROM NOTIF N, D
  WHERE N.CODE = D.CODE_NOTIF ;
*/

-- Résultat de l'envoi d'une notification
CREATE TABLE NOTIF_RESULT (
  ID            NUMBER        NOT NULL CONSTRAINT NOTIF_RESULT_PK PRIMARY KEY,
  NOTIF_ID      NUMBER        NOT NULL CONSTRAINT NOTIF_RESULT__NOTIF_FK REFERENCES NOTIF(ID) ON DELETE CASCADE,
  SUJET         VARCHAR(255)  NOT NULL, -- sujet du message envoyé
  CORPS         CLOB          NOT NULL, -- corps du message envoyé
  DATE_ENVOI    DATE          NOT NULL, -- date et heure d'envoi du message
  ERREUR        CLOB                    -- erreur rencontrée éventuelle
);

create sequence NOTIF_ID_SEQ;
create sequence NOTIF_RESULT_ID_SEQ;


INSERT INTO NOTIF (ID, CODE, DESCRIPTION, DESTINATAIRES, TEMPLATE)
  select NOTIF_ID_SEQ.nextval, 'NOTIF_RESULTAT_PASSE_A_ADMIS__POUR_DOCTORANT', 'Description', '{doctorant}', '<p>Bonjour</p>,<p>ceci est une notification pour le doctorant.</p>' from dual;
INSERT INTO NOTIF (ID, CODE, DESCRIPTION, DESTINATAIRES, TEMPLATE)
  select NOTIF_ID_SEQ.nextval, 'NOTIF_RESULTAT_PASSE_A_ADMIS__POUR_BDD', 'Description', 'recherche.doctorat@unicaen.fr, bertrand.gauthier@unicaen.fr', '<p>Bonjour</p>,<p>ceci est une notification pour le BdD.</p>' from dual;

COMMIT;




ALTER TABLE IMPORT_OBSERV_RESULT DROP CONSTRAINT IMPORT_OBSERV_RESULT__IO_FK;
ALTER TABLE IMPORT_OBSERV_RESULT DROP CONSTRAINT IMPORT_OBSERV_FK;
ALTER TABLE IMPORT_OBSERV_RESULT DROP CONSTRAINT IMPORT_OBSERV_RESULT_FK;
ALTER TABLE IMPORT_OBSERV_RESULT
  ADD CONSTRAINT IMPORT_OBSERV_RESULT__IO_FK FOREIGN KEY (IMPORT_OBSERV_ID) REFERENCES IMPORT_OBSERV (ID) ON DELETE CASCADE;



-- Destinataires de la notification déclenchée par cette observation
CREATE TABLE IMPORT_OBS_NOTIF (
  ID               NUMBER NOT NULL CONSTRAINT IOND_PK PRIMARY KEY,
  IMPORT_OBSERV_ID NUMBER NOT NULL CONSTRAINT IOND__IO_FK REFERENCES IMPORT_OBSERV(ID) ON DELETE CASCADE,
  NOTIF_ID         NUMBER NOT NULL CONSTRAINT IOND__N_FK REFERENCES NOTIF(ID) ON DELETE CASCADE
);

-- Résultat de la notification à propos d'un résultat d'observation
CREATE TABLE IMPORT_OBS_RESULT_NOTIF (
  ID                      NUMBER NOT NULL CONSTRAINT IORNR_PK PRIMARY KEY,
  IMPORT_OBSERV_RESULT_ID NUMBER NOT NULL CONSTRAINT IORNR__IOR_FK REFERENCES IMPORT_OBSERV_RESULT(ID) ON DELETE CASCADE,
  NOTIF_RESULT_ID         NUMBER NOT NULL CONSTRAINT IORNR__NR_FK REFERENCES NOTIF_RESULT(ID) ON DELETE CASCADE
);

create sequence IMPORT_OBS_NOTIF_ID_SEQ;
create sequence IMPORT_OBS_RESULT_NOTIF_ID_SEQ;




SELECT * FROM IMPORT_OBSERV;
SELECT * FROM IMPORT_OBSERV_RESULT;



insert into IMPORT_OBS_NOTIF(IMPORT_OBSERV_ID, NOTIF_ID)
    select io.id, '{doctorant}' --
    from IMPORT_OBSERV io where io.CODE = 'RESULTAT_PASSE_A_ADMIS'

