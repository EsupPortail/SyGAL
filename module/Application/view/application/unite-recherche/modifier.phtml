<?php

use Application\Entity\Db\Etablissement;
use Application\Form\EcoleDoctoraleForm;
use Application\Form\UniteRechercheForm;
use Application\View\Renderer\PhpRenderer;

/**
 * @var PhpRenderer        $this
 * @var string             $title
 * @var UniteRechercheForm $form
 *
* @method string formControlGroup()
*/

$fcg = $this->formControlGroup();
?>

<div>
    <h1> Modification d'unité de recherche :  </h1>

    <?php
    $messenger = $this->messenger();
    echo $messenger->addMessagesFromFlashMessenger();
    ?>

    <div>
    <h2> Informations générales </h2>
    <div class="col-md-6">
<?php echo $this->form()->openTag($form->prepare()->setAttribute('class', 'unite-recherche')) ?>
<?php echo $this->formHidden($form->get('id')) ?>
<?php echo $fcg($form->get('libelle')) ?>
<?php echo $fcg($form->get('sigle')) ?>
<?php echo $fcg($form->get('sourceCode')) ?>
    </div>

    <div class="col-md-6" id="logo-div">
    <?php
    /** @var \Zend\Form\Element\File $logoFile */
    $logoFile = $form->get('cheminLogo');
    echo $this->formLabel($logoFile);
    ?>

    <?php
    $content = $form->getObject()->getLogoContent();
    if ($content === null) {
        $form->getObject()->setCheminLogo(null);
    }
    ?>
    <table>
        <tr>
            <td>
                <img
                        id="logo"
                    style="max-width: 200px; max-height: 200px; border: 1px solid black; background-color: white;"
                    src="data:image/png;base64,<?php echo base64_encode($form->getObject()->getLogoContent()); ?>"
                />
            </td>
            <td style="padding:20px;">
                <?php
                echo $this->formFile($logoFile);
                echo $this->formElementErrors($logoFile);
                echo $this->formElement($form->get('supprimer-logo'));
                ?>
            </td>
        </tr>
    </table>
</div>

        <div style="clear:both;"></div>

<div>
    <h2> Établissements de rattachement </h2>
    <div class="col-md-6">
        <table class="table table-extra-condensed">
            <thead>
                <tr><th> Libellé</th>  <th> Action </th></tr>
            </thead>
            <tbody>
                <?php
                    /** @var \Application\Entity\Db\EtablissementRattachement $etablissementRattachement */
                foreach ($etablissementsRattachements as $etablissementRattachement) {
                        echo '<tr>';
                        echo '<td>';
                        if ($etablissementRattachement->isPrincipal()) echo '<strong>';
                        echo $etablissementRattachement->getEtablissement()->getLibelle();
                        if ($etablissementRattachement->isPrincipal()) echo '</strong>';
                        echo '</td>';

                        echo '<td>';
                            echo '<a href="'.$this->url("unite-recherche/retirer-etablissement-rattachement",
                                    ["etablissement"=>$etablissementRattachement->getEtablissement()->getId()],[],true).'">';
                            echo '<span class="glyphicon glyphicon-trash"></span>';
                            echo '</a>';
                            echo '<a href="'.$this->url("unite-recherche/principal-etablissement-rattachement",
                                    ["etablissement"=>$etablissementRattachement->getEtablissement()->getId()],[],true).'">';
                            echo '<span class="glyphicon glyphicon-star"></span>';
                            echo '</a>';
                        echo '</td>';
                        echo '</tr>';
                    }
                ?>
            </tbody>
        </table>
    </div>
    <div class="col-md-6">
        <?php echo generateSelect($etablissements); ?>

        <a id="ajout" href="<?php echo $this->url("unite-recherche/ajouter-etablissement-rattachement", ["etablissement" => 389], [], true);?>"> Ajouter </a>
    </div>
</div>

        <div style="clear:both;"></div>
<?php echo $this->formElement($form->get('submit')) ?>
<?php echo $this->form()->closeTag() ?>

<?php
$this->translate("Libellé :");
$this->translate("Sigle :");
$this->translate("Code :");
$this->translate("Enregistrer");
$this->translate("Supprimer le logo");
$this->translate("Logo de l'unité de recherche :");


function generateSelect($etablissements) {
    $texte = '';
    $texte .= '<select id="etablissements">';
    $texte .= '<option> Choisissez un établissement de rattachement ...</option>';
    foreach ($etablissements as $etablissement) {
        /** @var Etablissement $etablissement */
        $texte .= '<option value="'.$etablissement->getId().'">'.$etablissement->getLibelle().'</option>';
    }
    $texte .= '</select>';
    return $texte;
}
?>

<script>
    $(document).ready(function() {

        //remplacement dans la structure cible
        $("input[name='cheminLogo']").on("change", function () {

            var myFile = $("input[name='cheminLogo']").prop('files');
            console.log(myFile[0]);
            fr = new FileReader();
            fr.onload = function () {
                var content = fr.result;
                console.log(content);
                $('#logo').attr("src", content);
            };
            fr.readAsDataURL( myFile[0] );
        });

        $("#etablissements").on("change", function () {
           var etablissementId = $("#etablissements").val();
           $("a#ajout").attr("href", "ajouter-etablissement-rattachement/" + etablissementId);
           //alert($("#etablissements").val());
        });
    });
</script>
