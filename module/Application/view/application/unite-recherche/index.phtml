<?php

use Application\Entity\Db\UniteRecherche;
use Application\Filter\EtablissementPrefixFilter;
use Application\Provider\Privilege\UniteRecherchePrivileges;
use Application\View\Renderer\PhpRenderer;

/**
 * @see \Application\Controller\EcoleDoctoraleController::indexAction()
 * @var PhpRenderer      $this
 * @var UniteRecherche[] $unites
 */

$canModifier = $this->isAllowed(UniteRecherchePrivileges::getResourceId(UniteRecherchePrivileges::UNITE_RECH_MODIFICATION));
$canAjouter = $this->isAllowed(UniteRecherchePrivileges::getResourceId(UniteRecherchePrivileges::UNITE_RECH_CREATION));

$prefixFilter = new EtablissementPrefixFilter();
?>


<?php $this->headTitle($this->translate("Unités de recherche")) ?>

<h1 class="page-header first">
    <?php echo $this->translate("Unités de recherche") ?>
    <span class="badge"><?php echo count($unites); ?></span>
</h1>

<?php echo $this->messenger()->addMessagesFromFlashMessengerWithNoNamespace() ?>

<?php if ($canAjouter): ?>

    <a href="<?php echo $this->url('unite-recherche/ajouter', [], [], true) ?>"
       class="btn btn-primary"
       title="<?php echo $this->translate("Créer une nouvelle unité de recherche"); ?>">
        <span class="glyphicon glyphicon-plus"></span>
        <?php echo $this->translate("Ajouter une nouvelle unité de recherche"); ?>
    </a>
<?php endif ?>

<div>
    <table class="table table-condensed">
        <thead>
        <tr>
            <th> Libellé</th>
            <th> Source</th>
            <th> Code</th>
            <th> Sigle</th>
            <th> Identifiant RNSR</th>
<!--            <th> #these</th>-->
            <th> Actions</th>
        </tr>
        </thead>
        <tbody>
        <?php foreach ($unites as $unite): ?>

            <?php
            $historisee = (!$unite->estNonHistorise());
            $hasSousStructure = !($unite->getStructure()->getStructuresSubstituees()->isEmpty());
            ?>

            <tr>
                <td>
                    <a href="<?php echo $this->url('unite-recherche/information', ['uniteRecherche' => $unite->getStructure()->getId()], [], true); ?>">
                        <?php echo $unite->getLibelle(); ?>
                    </a>
                </td>
                <td>
                    <?php echo $prefixFilter->extractCodeEtablissementFrom($unite->getSource()->getCode()); ?>
                </td>
                <td>
                    <?php echo $unite->getStructure()->getCode(); ?>
                </td>
                <td> <?php echo $unite->getSigle(); ?> </td>
                <td> <?php echo $unite->getRNSR(); ?> </td>
<!--                <td> --><?php //echo count($unite->getTheses()); ?><!-- </td>-->
                <td>
                    <?php if ($canAjouter && !$historisee) : ?>
                        <a href="<?php echo $this->url('unite-recherche/supprimer', ["uniteRecherche" => $unite->getStructure()->getId()], [], true); ?>"
                           title="Historiser l'établissement">
                            <span class="glyphicon glyphicon-trash"></span>
                        </a>
                    <?php endif; ?>

                    <?php if ($canModifier && !$historisee && $hasSousStructure) : ?>
                        <a href="<?php echo $this->url('substitution-modifier', ['cible' => $unite->getStructure()->getId(), [], true]); ?>"
                           title="Historiser l'établissement">
                            <span class="glyphicon glyphicon-link" title="Éditer la substitution"></span>
                        </a>
                    <?php endif; ?>

                    <?php if ($canAjouter && $historisee) : ?>
                        <a href="<?php echo $this->url('unite-recherche/restaurer', ["uniteRecherche" => $unite->getStructure()->getId()], [], true); ?>"
                           title="Restaurer l'établissement">
                            Restaurer
                        </a>
                    <?php endif; ?>
                </td>
            </tr>

        <?php endforeach; ?>

        </tbody>
    </table>
</div>