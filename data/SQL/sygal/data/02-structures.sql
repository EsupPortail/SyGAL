
-- TYPE_STRUCTURE

insert into TYPE_STRUCTURE(ID, CODE, LIBELLE) values (1, 'etablissement',   'Établissement');
insert into TYPE_STRUCTURE(ID, CODE, LIBELLE) values (2, 'ecole-doctorale', 'École doctorale');
insert into TYPE_STRUCTURE(ID, CODE, LIBELLE) values (3, 'unite-recherche', 'Unité de recherche');


-- STRUCTURE

INSERT INTO STRUCTURE (ID, CODE, SIGLE, LIBELLE, CHEMIN_LOGO, TYPE_STRUCTURE_ID, HISTO_CREATION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTION, HISTO_DESTRUCTEUR_ID, SOURCE_ID, SOURCE_CODE)
  select 1, 'COMUE', 'NU', 'Normandie Université', null, null, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 1, null, null, s.id, 'COMUE::1'
  from SOURCE s WHERE CODE = 'SYGAL::sygal';
INSERT INTO STRUCTURE (ID, CODE, SIGLE, LIBELLE, CHEMIN_LOGO, TYPE_STRUCTURE_ID, HISTO_CREATION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTION, HISTO_DESTRUCTEUR_ID, SOURCE_ID, SOURCE_CODE)
  select 2, 'UCN', 'Unicaen', 'Université de Caen Normandie', null, 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 1, null, null, s.id, 'COMUE::2'
  from SOURCE s WHERE CODE = 'SYGAL::sygal';
INSERT INTO STRUCTURE (ID, CODE, SIGLE, LIBELLE, CHEMIN_LOGO, TYPE_STRUCTURE_ID, HISTO_CREATION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTION, HISTO_DESTRUCTEUR_ID, SOURCE_ID, SOURCE_CODE)
  select 3, 'URN', 'Univ-Rouen', 'Université de Rouen Normandie', null, 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 1, null, null, s.id, 'COMUE::3'
  from SOURCE s WHERE CODE = 'SYGAL::sygal';
INSERT INTO STRUCTURE (ID, CODE, SIGLE, LIBELLE, CHEMIN_LOGO, TYPE_STRUCTURE_ID, HISTO_CREATION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTION, HISTO_DESTRUCTEUR_ID, SOURCE_ID, SOURCE_CODE)
  select 4, 'ULHN', 'Univ-LeHavre', 'Université Le Havre Normandie', null, 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 1, null, null, s.id, 'COMUE::4'
  from SOURCE s WHERE CODE = 'SYGAL::sygal';
INSERT INTO STRUCTURE (ID, CODE, SIGLE, LIBELLE, CHEMIN_LOGO, TYPE_STRUCTURE_ID, HISTO_CREATION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTION, HISTO_DESTRUCTEUR_ID, SOURCE_ID, SOURCE_CODE)
  select 5, 'INSA', 'INSA-Rouen', 'INSA de Rouen', null, 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 1, null, null, s.id, 'COMUE::5'
  from SOURCE s WHERE CODE = 'SYGAL::sygal';


DECLARE
  maxid NUMBER;
  nextval NUMBER;
BEGIN
  select max(id) into maxid from STRUCTURE;
  loop
    select STRUCTURE_ID_SEQ.nextval into nextval from dual;
    EXIT WHEN maxid < nextval;
  end loop;
END;
/


-- ETABLISSEMENT

INSERT INTO ETABLISSEMENT (ID, STRUCTURE_ID, DOMAINE, SOURCE_ID, SOURCE_CODE, HISTO_CREATION, HISTO_DESTRUCTION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTEUR_ID) VALUES (
  ETABLISSEMENT_id_seq.nextval, 1, null,              1, 'COMUE::1', TO_DATE('2018-03-05 09:09:02', 'YYYY-MM-DD HH24:MI:SS'), null, 1, TO_DATE('2018-03-05 09:16:45', 'YYYY-MM-DD HH24:MI:SS'), 1, null
);
INSERT INTO ETABLISSEMENT (ID, STRUCTURE_ID, DOMAINE, SOURCE_ID, SOURCE_CODE, HISTO_CREATION, HISTO_DESTRUCTION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTEUR_ID) VALUES (
  ETABLISSEMENT_id_seq.nextval,   2, 'unicaen.fr',      1, 'COMUE::2', TO_DATE('2018-03-05 09:09:02', 'YYYY-MM-DD HH24:MI:SS'), null, 1, TO_DATE('2018-03-05 09:16:45', 'YYYY-MM-DD HH24:MI:SS'), 1, null
);
INSERT INTO ETABLISSEMENT (ID, STRUCTURE_ID, DOMAINE, SOURCE_ID, SOURCE_CODE, HISTO_CREATION, HISTO_DESTRUCTION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTEUR_ID) VALUES (
  ETABLISSEMENT_id_seq.nextval,   3, 'univ-rouen.fr',   1, 'COMUE::3', TO_DATE('2018-03-05 09:09:02', 'YYYY-MM-DD HH24:MI:SS'), null, 1, TO_DATE('2018-03-05 09:16:45', 'YYYY-MM-DD HH24:MI:SS'), 1, null
);
INSERT INTO ETABLISSEMENT (ID, STRUCTURE_ID, DOMAINE, SOURCE_ID, SOURCE_CODE, HISTO_CREATION, HISTO_DESTRUCTION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTEUR_ID) VALUES (
  ETABLISSEMENT_id_seq.nextval,  4, 'univ-lehavre.fr', 1, 'COMUE::4', TO_DATE('2018-03-05 09:09:02', 'YYYY-MM-DD HH24:MI:SS'), null, 1, TO_DATE('2018-03-05 09:16:45', 'YYYY-MM-DD HH24:MI:SS'), 1, null
);
INSERT INTO ETABLISSEMENT (ID, STRUCTURE_ID, DOMAINE, SOURCE_ID, SOURCE_CODE, HISTO_CREATION, HISTO_DESTRUCTION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTEUR_ID) VALUES (
  ETABLISSEMENT_id_seq.nextval,  5, 'insa-rouen.fr',   1, 'COMUE::5', TO_DATE('2018-03-05 09:09:02', 'YYYY-MM-DD HH24:MI:SS'), null, 1, TO_DATE('2018-03-05 09:16:45', 'YYYY-MM-DD HH24:MI:SS'), 1, null
);

DECLARE
  maxid NUMBER;
  nextval NUMBER;
BEGIN
  select max(id) into maxid from ETABLISSEMENT;
  loop
    select ETABLISSEMENT_ID_SEQ.nextval into nextval from dual;
    EXIT WHEN maxid < nextval;
  end loop;
END;
/



-- Vérif :
-- - le type structure doit être exact
-- - les SOURCE_CODE doivent correspondre selon le type de structure
--
select ts.CODE, e.SOURCE_CODE, s.LIBELLE, s.SOURCE_CODE
from structure s
  join TYPE_STRUCTURE ts on ts.id = s.TYPE_STRUCTURE_ID
  left join etablissement e on e.STRUCTURE_ID = s.id
;

