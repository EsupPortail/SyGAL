
-- TYPE_STRUCTURE

insert into TYPE_STRUCTURE(ID, CODE, LIBELLE) values (1, 'etablissement',   'Établissement');
insert into TYPE_STRUCTURE(ID, CODE, LIBELLE) values (2, 'ecole-doctorale', 'École doctorale');
insert into TYPE_STRUCTURE(ID, CODE, LIBELLE) values (3, 'unite-recherche', 'Unité de recherche');

-- STRUCTURE

create table S_ECOLE_DOCT as select * from sodoct.ECOLE_DOCT@doctprod;
create table S_UNITE_RECH as select * from sodoct.UNITE_RECH@doctprod;

drop sequence STRUCTURE_id_seq;
create sequence STRUCTURE_id_seq;

INSERT INTO STRUCTURE (ID, SIGLE, LIBELLE, CHEMIN_LOGO, TYPE_STRUCTURE_ID, HISTO_CREATION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTION, HISTO_DESTRUCTEUR_ID, SOURCE_ID, SOURCE_CODE)
  select STRUCTURE_ID_SEQ.nextval, 'NU', 'Normandie Université', null, null, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 2, null, null, s.id, 'COMUE::1'
  from SOURCE s WHERE CODE = 'COMUE::SYGAL';
INSERT INTO STRUCTURE (ID, SIGLE, LIBELLE, CHEMIN_LOGO, TYPE_STRUCTURE_ID, HISTO_CREATION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTION, HISTO_DESTRUCTEUR_ID, SOURCE_ID, SOURCE_CODE)
  select STRUCTURE_ID_SEQ.nextval, 'Unicaen', 'Université de Caen Normandie', null, 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 2, null, null, s.id, 'COMUE::2'
  from SOURCE s WHERE CODE = 'COMUE::SYGAL';
INSERT INTO STRUCTURE (ID, SIGLE, LIBELLE, CHEMIN_LOGO, TYPE_STRUCTURE_ID, HISTO_CREATION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTION, HISTO_DESTRUCTEUR_ID, SOURCE_ID, SOURCE_CODE)
  select STRUCTURE_ID_SEQ.nextval, 'Univ-Rouen', 'Université de Rouen Normandie', null, 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 2, null, null, s.id, 'COMUE::3'
  from SOURCE s WHERE CODE = 'COMUE::SYGAL';
INSERT INTO STRUCTURE (ID, SIGLE, LIBELLE, CHEMIN_LOGO, TYPE_STRUCTURE_ID, HISTO_CREATION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTION, HISTO_DESTRUCTEUR_ID, SOURCE_ID, SOURCE_CODE)
  select STRUCTURE_ID_SEQ.nextval, 'Univ-LeHavre', 'Université Le Havre Normandie', null, 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 2, null, null, s.id, 'COMUE::4'
  from SOURCE s WHERE CODE = 'COMUE::SYGAL';
INSERT INTO STRUCTURE (ID, SIGLE, LIBELLE, CHEMIN_LOGO, TYPE_STRUCTURE_ID, HISTO_CREATION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTION, HISTO_DESTRUCTEUR_ID, SOURCE_ID, SOURCE_CODE)
  select STRUCTURE_ID_SEQ.nextval, 'INSA-Rouen', 'INSA de Rouen', null, 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 2, null, null, s.id, 'COMUE::5'
  from SOURCE s WHERE CODE = 'COMUE::SYGAL';

insert into STRUCTURE(
  ID,
  LIBELLE,
  SIGLE,
  CHEMIN_LOGO,
  TYPE_STRUCTURE_ID,
  SOURCE_ID,
  SOURCE_CODE,
  HISTO_CREATION,
  HISTO_CREATEUR_ID,
  HISTO_MODIFICATION,
  HISTO_MODIFICATEUR_ID,
  HISTO_DESTRUCTION,
  HISTO_DESTRUCTEUR_ID
)
select
  STRUCTURE_ID_SEQ.nextval,
  LIBELLE,
  SIGLE,
  null as CHEMIN_LOGO,
  (select id from TYPE_STRUCTURE where CODE = 'ecole-doctorale') as TYPE_STRUCTURE_ID,
  (select id from source where code = 'UCN::apogee') as SOURCE_ID,
  'UCN::' || SOURCE_CODE as SOURCE_CODE,
  HISTO_CREATION,
  HISTO_CREATEUR_ID,
  HISTO_MODIFICATION,
  HISTO_MODIFICATEUR_ID,
  HISTO_DESTRUCTION,
  HISTO_DESTRUCTEUR_ID
from S_ECOLE_DOCT
;

insert into STRUCTURE(
  ID,
  LIBELLE,
  SIGLE,
  CHEMIN_LOGO,
  TYPE_STRUCTURE_ID,
  SOURCE_ID,
  SOURCE_CODE,
  HISTO_CREATION,
  HISTO_CREATEUR_ID,
  HISTO_MODIFICATION,
  HISTO_MODIFICATEUR_ID,
  HISTO_DESTRUCTION,
  HISTO_DESTRUCTEUR_ID
)
select
  STRUCTURE_ID_SEQ.nextval,
  LIBELLE,
  SIGLE,
  null as CHEMIN_LOGO,
  (select id from TYPE_STRUCTURE where CODE = 'unite-recherche') as TYPE_STRUCTURE_ID,
  (select id from source where code = 'UCN::apogee') as SOURCE_ID,
  'UCN::' || SOURCE_CODE as SOURCE_CODE,
  HISTO_CREATION,
  HISTO_CREATEUR_ID,
  HISTO_MODIFICATION,
  HISTO_MODIFICATEUR_ID,
  HISTO_DESTRUCTION,
  HISTO_DESTRUCTEUR_ID
from S_UNITE_RECH
;

-- ETABLISSEMENT

INSERT INTO ETABLISSEMENT (ID, CODE, STRUCTURE_ID, DOMAINE, SOURCE_ID, SOURCE_CODE, HISTO_CREATION, HISTO_DESTRUCTION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTEUR_ID) VALUES (
  ETABLISSEMENT_id_seq.nextval, 'COMUE', 1, null,              2, 'COMUE::1', TO_DATE('2018-03-05 09:09:02', 'YYYY-MM-DD HH24:MI:SS'), null, 1, TO_DATE('2018-03-05 09:16:45', 'YYYY-MM-DD HH24:MI:SS'), 1, null
);
INSERT INTO ETABLISSEMENT (ID, CODE, STRUCTURE_ID, DOMAINE, SOURCE_ID, SOURCE_CODE, HISTO_CREATION, HISTO_DESTRUCTION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTEUR_ID) VALUES (
  ETABLISSEMENT_id_seq.nextval, 'UCN',   2, 'unicaen.fr',      2, 'COMUE::2', TO_DATE('2018-03-05 09:09:02', 'YYYY-MM-DD HH24:MI:SS'), null, 1, TO_DATE('2018-03-05 09:16:45', 'YYYY-MM-DD HH24:MI:SS'), 1, null
);
INSERT INTO ETABLISSEMENT (ID, CODE, STRUCTURE_ID, DOMAINE, SOURCE_ID, SOURCE_CODE, HISTO_CREATION, HISTO_DESTRUCTION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTEUR_ID) VALUES (
  ETABLISSEMENT_id_seq.nextval, 'URN',   3, 'univ-rouen.fr',   2, 'COMUE::3', TO_DATE('2018-03-05 09:09:02', 'YYYY-MM-DD HH24:MI:SS'), null, 1, TO_DATE('2018-03-05 09:16:45', 'YYYY-MM-DD HH24:MI:SS'), 1, null
);
INSERT INTO ETABLISSEMENT (ID, CODE, STRUCTURE_ID, DOMAINE, SOURCE_ID, SOURCE_CODE, HISTO_CREATION, HISTO_DESTRUCTION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTEUR_ID) VALUES (
  ETABLISSEMENT_id_seq.nextval, 'ULHN',  4, 'univ-lehavre.fr', 2, 'COMUE::4', TO_DATE('2018-03-05 09:09:02', 'YYYY-MM-DD HH24:MI:SS'), null, 1, TO_DATE('2018-03-05 09:16:45', 'YYYY-MM-DD HH24:MI:SS'), 1, null
);
INSERT INTO ETABLISSEMENT (ID, CODE, STRUCTURE_ID, DOMAINE, SOURCE_ID, SOURCE_CODE, HISTO_CREATION, HISTO_DESTRUCTION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTEUR_ID) VALUES (
  ETABLISSEMENT_id_seq.nextval, 'INSA',  5, 'insa-rouen.fr',   2, 'COMUE::5', TO_DATE('2018-03-05 09:09:02', 'YYYY-MM-DD HH24:MI:SS'), null, 1, TO_DATE('2018-03-05 09:16:45', 'YYYY-MM-DD HH24:MI:SS'), 1, null
);

select * from structure;
select * from ETABLISSEMENT;

-- ECOLE_DOCT

insert into ECOLE_DOCT (
  ID,
  STRUCTURE_ID,
  SOURCE_ID,
  SOURCE_CODE,
  HISTO_CREATION,
  HISTO_CREATEUR_ID,
  HISTO_MODIFICATION,
  HISTO_MODIFICATEUR_ID,
  HISTO_DESTRUCTION,
  HISTO_DESTRUCTEUR_ID
)
select
  ID,
  (
    select s.id from STRUCTURE s join TYPE_STRUCTURE ts on ts.id = s.TYPE_STRUCTURE_ID
    where SOURCE_CODE = 'UCN::' || ed.SOURCE_CODE and ts.CODE = 'ecole-doctorale'
  ) as STRUCTURE_ID,
  (select id from source where code = 'UCN::apogee') as SOURCE_ID,
  'UCN::' || SOURCE_CODE as SOURCE_CODE,
  HISTO_CREATION,
  HISTO_CREATEUR_ID,
  HISTO_MODIFICATION,
  HISTO_MODIFICATEUR_ID,
  HISTO_DESTRUCTION,
  HISTO_DESTRUCTEUR_ID
from S_ECOLE_DOCT ed
;

DECLARE
  maxid NUMBER;
  nextval NUMBER;
BEGIN
  select max(id) into maxid from ECOLE_DOCT;
  loop
    select ECOLE_DOCT_ID_SEQ.nextval into nextval from dual;
    EXIT WHEN maxid < nextval;
  end loop;
END;
/

-- UNITE_RECH

insert into UNITE_RECH(
  ID,
  STRUCTURE_ID,
  SOURCE_ID,
  SOURCE_CODE,
  ETAB_SUPPORT,
  AUTRES_ETAB,
  HISTO_CREATION,
  HISTO_CREATEUR_ID,
  HISTO_MODIFICATION,
  HISTO_MODIFICATEUR_ID,
  HISTO_DESTRUCTION,
  HISTO_DESTRUCTEUR_ID
)
select
  ID,
  (
    select s.id from STRUCTURE s join TYPE_STRUCTURE ts on ts.id = s.TYPE_STRUCTURE_ID
    where SOURCE_CODE = 'UCN::' || ur.SOURCE_CODE and ts.CODE = 'unite-recherche'
  ) as STRUCTURE_ID,
  (select id from source where code = 'UCN::apogee') as SOURCE_ID,
  'UCN::' || SOURCE_CODE as SOURCE_CODE,
  ETAB_SUPPORT,
  AUTRES_ETAB,
  HISTO_CREATION,
  HISTO_CREATEUR_ID,
  HISTO_MODIFICATION,
  HISTO_MODIFICATEUR_ID,
  HISTO_DESTRUCTION,
  HISTO_DESTRUCTEUR_ID
from S_UNITE_RECH ur
;

DECLARE
  maxid NUMBER;
  nextval NUMBER;
BEGIN
  select max(id) into maxid from UNITE_RECH;
  loop
    select UNITE_RECH_ID_SEQ.nextval into nextval from dual;
    EXIT WHEN maxid < nextval;
  end loop;
END;
/



-- Vérif :
-- - le type structure doit être exact
-- - les SOURCE_CODE doivent correspondre selon le type de structure
--
select ts.CODE, e.SOURCE_CODE, ed.SOURCE_CODE, ur.SOURCE_CODE, s.LIBELLE, s.SOURCE_CODE
from structure s
  join TYPE_STRUCTURE ts on ts.id = s.TYPE_STRUCTURE_ID
  left join etablissement e on e.STRUCTURE_ID = s.id
  left join ECOLE_DOCT ed on ed.STRUCTURE_ID = s.id
  left join UNITE_RECH ur on ur.STRUCTURE_ID = s.id
;


--

drop table S_ECOLE_DOCT;
drop table S_UNITE_RECH;
