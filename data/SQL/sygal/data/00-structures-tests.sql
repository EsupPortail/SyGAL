-- for tests
drop table STRUCTURE_XX ;
drop table ETABLISSEMENT_XX ;
drop table ECOLE_DOCT_XX ;
drop table UNITE_RECH_XX ;
drop sequence STRUCTURE_XX_id_seq;
drop sequence ETABLISSEMENT_XX_id_seq;
drop sequence ECOLE_DOCT_XX_id_seq;
drop sequence UNITE_RECH_XX_id_seq;
create table STRUCTURE_XX as select * from STRUCTURE where 1=0;
create table ETABLISSEMENT_XX as select * from ETABLISSEMENT where 1=0;
create table ECOLE_DOCT_XX as select * from ECOLE_DOCT where 1=0;
create table UNITE_RECH_XX as select * from UNITE_RECH where 1=0;
create sequence STRUCTURE_XX_id_seq;
create sequence ETABLISSEMENT_XX_id_seq;
create sequence ECOLE_DOCT_XX_id_seq;
create sequence UNITE_RECH_XX_id_seq;
-- en réel, remplacer ci-dessous '_XX' par ''.


-- TYPE_STRUCTURE

insert into TYPE_STRUCTURE(ID, CODE, LIBELLE) values (1, 'etablissement',   'Établissement');
insert into TYPE_STRUCTURE(ID, CODE, LIBELLE) values (2, 'ecole-doctorale', 'École doctorale');
insert into TYPE_STRUCTURE(ID, CODE, LIBELLE) values (3, 'unite-recherche', 'Unité de recherche');

-- STRUCTURE

create table S_ECOLE_DOCT as select * from sodoct.ECOLE_DOCT@doctprod;
create table S_UNITE_RECH as select * from sodoct.UNITE_RECH@doctprod;

drop sequence STRUCTURE_XX_id_seq;
create sequence STRUCTURE_XX_id_seq;

INSERT INTO STRUCTURE_XX (ID, SIGLE, LIBELLE, CHEMIN_LOGO, TYPE_STRUCTURE_ID, HISTO_CREATION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTION, HISTO_DESTRUCTEUR_ID, SOURCE_ID, SOURCE_CODE) VALUES
  (STRUCTURE_XX_ID_SEQ.nextval, 'NU', 'Normandie Université', null, null, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 2, null, null, 2, 'UCN::1');
INSERT INTO STRUCTURE_XX (ID, SIGLE, LIBELLE, CHEMIN_LOGO, TYPE_STRUCTURE_ID, HISTO_CREATION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTION, HISTO_DESTRUCTEUR_ID, SOURCE_ID, SOURCE_CODE) VALUES
  (STRUCTURE_XX_ID_SEQ.nextval, 'Unicaen', 'Université de Caen Normandie', null, 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 2, null, null, 2, 'UCN::2');
INSERT INTO STRUCTURE_XX (ID, SIGLE, LIBELLE, CHEMIN_LOGO, TYPE_STRUCTURE_ID, HISTO_CREATION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTION, HISTO_DESTRUCTEUR_ID, SOURCE_ID, SOURCE_CODE) VALUES
  (STRUCTURE_XX_ID_SEQ.nextval, 'Univ-Rouen', 'Université de Rouen Normandie', null, 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 2, null, null, 2, 'UCN::3');
INSERT INTO STRUCTURE_XX (ID, SIGLE, LIBELLE, CHEMIN_LOGO, TYPE_STRUCTURE_ID, HISTO_CREATION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTION, HISTO_DESTRUCTEUR_ID, SOURCE_ID, SOURCE_CODE) VALUES
  (STRUCTURE_XX_ID_SEQ.nextval, 'Univ-LeHavre', 'Université Le Havre Normandie', null, 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 2, null, null, 2, 'UCN::4');
INSERT INTO STRUCTURE_XX (ID, SIGLE, LIBELLE, CHEMIN_LOGO, TYPE_STRUCTURE_ID, HISTO_CREATION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTION, HISTO_DESTRUCTEUR_ID, SOURCE_ID, SOURCE_CODE) VALUES
  (STRUCTURE_XX_ID_SEQ.nextval, 'INSA-Rouen', 'INSA de Rouen', null, 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 1, TO_DATE('2018-04-09 11:05:58', 'YYYY-MM-DD HH24:MI:SS'), 2, null, null, 2, 'UCN::5');

insert into STRUCTURE_XX(
  ID,
  LIBELLE,
  SIGLE,
  CHEMIN_LOGO,
  TYPE_STRUCTURE_ID,
  SOURCE_ID,
  SOURCE_CODE,
  HISTO_CREATION,
  HISTO_CREATEUR_ID,
  HISTO_MODIFICATION,
  HISTO_MODIFICATEUR_ID,
  HISTO_DESTRUCTION,
  HISTO_DESTRUCTEUR_ID
)
  select
    STRUCTURE_XX_ID_SEQ.nextval,
    LIBELLE,
    SIGLE,
    null as CHEMIN_LOGO,
    (select id from TYPE_STRUCTURE where CODE = 'ecole-doctorale') as TYPE_STRUCTURE_ID,
    (select id from source where code = 'UCN::apogee') as SOURCE_ID,
    'UCN::' || SOURCE_CODE as SOURCE_CODE,
    HISTO_CREATION,
    HISTO_CREATEUR_ID,
    HISTO_MODIFICATION,
    HISTO_MODIFICATEUR_ID,
    HISTO_DESTRUCTION,
    HISTO_DESTRUCTEUR_ID
  from oth.S_ECOLE_DOCT
;

insert into STRUCTURE_XX(
  ID,
  LIBELLE,
  SIGLE,
  CHEMIN_LOGO,
  TYPE_STRUCTURE_ID,
  SOURCE_ID,
  SOURCE_CODE,
  HISTO_CREATION,
  HISTO_CREATEUR_ID,
  HISTO_MODIFICATION,
  HISTO_MODIFICATEUR_ID,
  HISTO_DESTRUCTION,
  HISTO_DESTRUCTEUR_ID
)
  select
    STRUCTURE_XX_ID_SEQ.nextval,
    LIBELLE,
    SIGLE,
    null as CHEMIN_LOGO,
    (select id from TYPE_STRUCTURE where CODE = 'unite-recherche') as TYPE_STRUCTURE_ID,
    (select id from source where code = 'UCN::apogee') as SOURCE_ID,
    'UCN::' || SOURCE_CODE as SOURCE_CODE,
    HISTO_CREATION,
    HISTO_CREATEUR_ID,
    HISTO_MODIFICATION,
    HISTO_MODIFICATEUR_ID,
    HISTO_DESTRUCTION,
    HISTO_DESTRUCTEUR_ID
  from oth.S_UNITE_RECH
;

-- ETABLISSEMENT

INSERT INTO ETABLISSEMENT_XX (ID, CODE, STRUCTURE_ID, DOMAINE, SOURCE_ID, SOURCE_CODE, HISTO_CREATION, HISTO_DESTRUCTION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTEUR_ID) VALUES (
  ETABLISSEMENT_XX_id_seq.nextval, 'COMUE', 1, null,              2, 'COMUE::1', TO_DATE('2018-03-05 09:09:02', 'YYYY-MM-DD HH24:MI:SS'), null, 1, TO_DATE('2018-03-05 09:16:45', 'YYYY-MM-DD HH24:MI:SS'), 1, null
);
INSERT INTO ETABLISSEMENT_XX (ID, CODE, STRUCTURE_ID, DOMAINE, SOURCE_ID, SOURCE_CODE, HISTO_CREATION, HISTO_DESTRUCTION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTEUR_ID) VALUES (
  ETABLISSEMENT_XX_id_seq.nextval, 'UCN',   2, 'unicaen.fr',      2, 'COMUE::2', TO_DATE('2018-03-05 09:09:02', 'YYYY-MM-DD HH24:MI:SS'), null, 1, TO_DATE('2018-03-05 09:16:45', 'YYYY-MM-DD HH24:MI:SS'), 1, null
);
INSERT INTO ETABLISSEMENT_XX (ID, CODE, STRUCTURE_ID, DOMAINE, SOURCE_ID, SOURCE_CODE, HISTO_CREATION, HISTO_DESTRUCTION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTEUR_ID) VALUES (
  ETABLISSEMENT_XX_id_seq.nextval, 'URN',   3, 'univ-rouen.fr',   2, 'COMUE::3', TO_DATE('2018-03-05 09:09:02', 'YYYY-MM-DD HH24:MI:SS'), null, 1, TO_DATE('2018-03-05 09:16:45', 'YYYY-MM-DD HH24:MI:SS'), 1, null
);
INSERT INTO ETABLISSEMENT_XX (ID, CODE, STRUCTURE_ID, DOMAINE, SOURCE_ID, SOURCE_CODE, HISTO_CREATION, HISTO_DESTRUCTION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTEUR_ID) VALUES (
  ETABLISSEMENT_XX_id_seq.nextval, 'ULHN',  4, 'univ-lehavre.fr', 2, 'COMUE::4', TO_DATE('2018-03-05 09:09:02', 'YYYY-MM-DD HH24:MI:SS'), null, 1, TO_DATE('2018-03-05 09:16:45', 'YYYY-MM-DD HH24:MI:SS'), 1, null
);
INSERT INTO ETABLISSEMENT_XX (ID, CODE, STRUCTURE_ID, DOMAINE, SOURCE_ID, SOURCE_CODE, HISTO_CREATION, HISTO_DESTRUCTION, HISTO_CREATEUR_ID, HISTO_MODIFICATION, HISTO_MODIFICATEUR_ID, HISTO_DESTRUCTEUR_ID) VALUES (
  ETABLISSEMENT_XX_id_seq.nextval, 'INSA',  5, 'insa-rouen.fr',   2, 'COMUE::5', TO_DATE('2018-03-05 09:09:02', 'YYYY-MM-DD HH24:MI:SS'), null, 1, TO_DATE('2018-03-05 09:16:45', 'YYYY-MM-DD HH24:MI:SS'), 1, null
);

-- ECOLE_DOCT

insert into ECOLE_DOCT_XX (
  ID,
  STRUCTURE_ID,
  SOURCE_ID,
  SOURCE_CODE,
  HISTO_CREATION,
  HISTO_CREATEUR_ID,
  HISTO_MODIFICATION,
  HISTO_MODIFICATEUR_ID,
  HISTO_DESTRUCTION,
  HISTO_DESTRUCTEUR_ID
)
  select
    ID,
    (
      select s.id from STRUCTURE_XX s join TYPE_STRUCTURE ts on ts.id = s.TYPE_STRUCTURE_ID
      where SOURCE_CODE = 'UCN::' || ed.SOURCE_CODE and ts.CODE = 'ecole-doctorale'
    ) as STRUCTURE_ID,
    (select id from source where code = 'UCN::apogee') as SOURCE_ID,
    'UCN::' || SOURCE_CODE as SOURCE_CODE,
    HISTO_CREATION,
    HISTO_CREATEUR_ID,
    HISTO_MODIFICATION,
    HISTO_MODIFICATEUR_ID,
    HISTO_DESTRUCTION,
    HISTO_DESTRUCTEUR_ID
  from oth.S_ECOLE_DOCT ed
;

DECLARE
  maxid NUMBER;
  nextval NUMBER;
BEGIN
  select max(id) into maxid from ECOLE_DOCT_XX;
  loop
    select ECOLE_DOCT_XX_ID_SEQ.nextval into nextval from dual;
    EXIT WHEN maxid < nextval;
  end loop;
END;
/

-- UNITE_RECH

insert into UNITE_RECH_XX(
  ID,
  STRUCTURE_ID,
  SOURCE_ID,
  SOURCE_CODE,
  ETAB_SUPPORT,
  AUTRES_ETAB,
  HISTO_CREATION,
  HISTO_CREATEUR_ID,
  HISTO_MODIFICATION,
  HISTO_MODIFICATEUR_ID,
  HISTO_DESTRUCTION,
  HISTO_DESTRUCTEUR_ID
)
  select
    ID,
    (
      select s.id from STRUCTURE_XX s join TYPE_STRUCTURE ts on ts.id = s.TYPE_STRUCTURE_ID
      where SOURCE_CODE = 'UCN::' || ur.SOURCE_CODE and ts.CODE = 'unite-recherche'
    ) as STRUCTURE_ID,
    (select id from source where code = 'UCN::apogee') as SOURCE_ID,
    'UCN::' || SOURCE_CODE as SOURCE_CODE,
    ETAB_SUPPORT,
    AUTRES_ETAB,
    HISTO_CREATION,
    HISTO_CREATEUR_ID,
    HISTO_MODIFICATION,
    HISTO_MODIFICATEUR_ID,
    HISTO_DESTRUCTION,
    HISTO_DESTRUCTEUR_ID
  from oth.S_UNITE_RECH ur
;

DECLARE
  maxid NUMBER;
  nextval NUMBER;
BEGIN
  select max(id) into maxid from UNITE_RECH_XX;
  loop
    select UNITE_RECH_XX_ID_SEQ.nextval into nextval from dual;
    EXIT WHEN maxid < nextval;
  end loop;
END;
/

--

drop table S_ECOLE_DOCT;
drop table S_UNITE_RECH;
